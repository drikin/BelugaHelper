<html>
    <script>
        function Settings(defaults) {
            this.defaults = defaults;
            this.storage = chrome.extension.getBackgroundPage().localStorage;

            var self = this;
            chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
                var action = request["action"] || request["method"];
                var key = request["key"];
                if(action === "getSettings") {
                    sendResponse(self.all());
                } else if(action === "getSetting" && key) {
                    sendResponse(self.get(key));
                }
            });
        }
        Settings.prototype = {
            get: function(key) {
                var value = this.storage.getItem(key)
                if(value === null && this.defaults.hasOwnProperty(key)) {
                    value = this.defaults[key];
                }
                // TODO unserialize value
                return value;
            },
            all: function() {
                var settings = {};
                for(var key in this.defaults) {
                    if(this.defaults.hasOwnProperty(key)) {
                        settings[key] = this.get(key);
                    }
                }
                return settings;
            },
            set: function(key, value) {
                // TODO serialize value
                this.storage.setItem(key, value);
                this.notify(key, value);
            },
            remove: function(key) {
                this.storage.removeItem(key);
            },
            notify: function(key, value) {
                chrome.extension.sendRequest({action: "updateSetting", key: key, value: value});
            }
        };

        // Default Settings Object
        window.settings = new Settings({
            useShiftEnterToPost: false
        });

        // Click from Browser Action Icon
        chrome.browserAction.onClicked.addListener(function(tab) {
            chrome.tabs.getAllInWindow(null, function(tabs) {
                var isOpened = false;
                var target_url = "http://belugapods.com/pods";
                for (var i = 0, n = tabs.length; i < n; i++) {
                    var tab = tabs[i];
                    if (tab.url === target_url) {
                        chrome.tabs.update(tab.id, {url: target_url, selected: true});
                        isOpened = true;
                        break;
                    }
                }
                if (!isOpened) {
                    chrome.tabs.create({url: target_url, selected: true});
                }
            });
        });

        // Request from Content Script
        chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
            if (request.type === "notification") {
                var notification = webkitNotifications.createNotification(
                    request.image_url,
                    request.name,
                    request.status);
                notification.ondisplay = function(event) {
                    setTimeout(function(){
                        event.target.cancel();
                    }, 4000);
                }
                notification.show();
            }
            sendResponse();
        });
    </script>
</html>
<!-- vim:set ts=4 sw=4 expandtab: -->
